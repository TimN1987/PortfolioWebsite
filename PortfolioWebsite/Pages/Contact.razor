@page "/contact"
@layout MainLayout
@inject IJSRuntime JS

<section class="contact-section">
    <h1 class="contact-header"><span>Contact</span></h1>

    <EditForm class="contact-form" Model="ContactModel" OnValidSubmit="SubmitForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <label for="name">Name</label>
        <InputText class="context-form-input" id="name" @bind-Value="ContactModel.Name" />
        <ValidationMessage For="@(() => ContactModel.Name)" />

        <label for="email">Email</label>
        <InputText class="context-form-input" id="email" type="email" @bind-Value="ContactModel.Email" />
        <ValidationMessage For="@(() => ContactModel.Email)" />

        <label for="message">Message</label>
        <InputTextArea class="context-form-textarea" id="message" @bind-Value="ContactModel.Message" rows="5" />
        <ValidationMessage For="@(() => ContactModel.Message)" />

        <button type="submit"><span>Submit</span></button>
    </EditForm>

    @if (IsSubmitted)
    {
        <p class="success-message">Thank you for your message, @ContactModel.Name! 🎉</p>
    }
</section>


@code {
	private ContactFormModel ContactModel { get; set; } = new();
	private bool IsSubmitted { get; set; } = false;
    private string CaptchaToken { get; set; } = "";

    [Inject] private HttpClient Http { get; set; } = default!;

    private async Task SubmitForm()
    {
        CaptchaToken = await JS.InvokeAsync<string>("getRecaptchaToken");

        if (string.IsNullOrWhiteSpace(CaptchaToken))
        {
            Console.WriteLine("Failed to retrieve reCAPTCHA token.");
            return;
        }

        ContactModel.Name = ContactModel.Name.Trim();
        ContactModel.Email = ContactModel.Email.Trim();
        ContactModel.Message = ContactModel.Message.Trim();

        var url = "https://exploringcoding.co.uk/api/contact.php";

        var payload = new
        {
            name = ContactModel.Name,
            email = ContactModel.Email,
            subject = "Portfolio query",
            message = ContactModel.Message,
            captcha = CaptchaToken
        };

        try
        {
            var response = await Http.PostAsJsonAsync(url, payload);

            var json = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                IsSubmitted = true;
                ContactModel = new ContactFormModel();
            }
            else
            {
                Console.WriteLine($"Form submission failed: {json}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error submitting form: {ex.Message}");
        }
    }


    public class ContactFormModel
    {
        [Required]
        [RegularExpression(@"^[\p{L}\s'-]{2,100}$",
            ErrorMessage = "Name must be 2–100 characters and contain only letters, spaces, hyphens, or apostrophes.")]
        public string Name { get; set; } = string.Empty;

        [Required]
        [EmailAddress]
        [StringLength(254)]
        public string Email { get; set; } = string.Empty;

        [Required]
        [StringLength(400, MinimumLength = 10,
            ErrorMessage = "Message must be between 10 and 400 characters.")]
        public string Message { get; set; } = string.Empty;
    }

}

